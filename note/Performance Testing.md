# Performance Testing

## 什么是性能测试
- 概念：使用自动化工具，模拟不同场景，对软件各项性能指标进行测试和评估的过程
- 作用：
    - 1.系统上线时，评估当前系统能力
    - 2.系统上线后，寻找性能瓶颈，优化性能
    - 3. 评估软件是否能够满足未来的需要

## 功能测试与性能测试对比

| 测试类型 | 定义 | 主要焦点 | 示例 |
|---------|------|---------|------|
| **功能测试** | 验证软件系统操作功能是否符合产品功能需求规格 | 功能（正向、逆向） | 正向（功能）：输入正确的用户名密码，登录成功<br>逆向（功能）：输入错误的用户名密码，登录失败给出提示 |
| **性能测试** | 验证软件系统是否满足业务需求场景 | 业务场景的满足(时间、资源) | 时间：100W人使用正确的用户名密码登录，1s内能登录成功<br>资源：服务器的CPU使用率低于70%，内存使用率低于60%等 |


## 性能测试工具

### Jmeter
- 概念：Apache JMeter是一个开源的性能测试工具，用于测试Web应用程序的性能。
- 作用：
    - 1. 模拟不同用户并发访问，测试系统在高负载下的性能
    - 2. 测试系统的响应时间、吞吐量、并发用户数等性能指标
- 安装：
    - 1. 从官方网站下载JMeter安装包
    - 2. 解压安装包到本地目录
    - 3. 配置环境变量，将JMeter的bin目录添加到PATH中
- 使用：
    - 1. 打开JMeter，创建一个新的测试计划
    - 2. 添加线程组，配置并发用户数、循环次数等
    - 3. 添加HTTP请求，配置URL、参数、请求头等
    - 4. 添加监听器，查看测试结果
        - 1. 查看结果树：查看每个请求的响应结果
        - 2. 查看聚合报告：查看系统的吞吐量、响应时间、并发用户数等指标
        - 3. 查看图形表示：以图表形式展示测试结果

### ServerAgent
- 概念：ServerAgent是一个用于监控服务器性能的工具，它可以收集服务器的CPU、内存、磁盘、网络等性能指标。
- 作用：
    - 1. 监控服务器性能，及时发现性能问题
    - 2. 收集服务器性能数据，用于性能测试和优化
- 使用：
    - 1. 打开ServerAgent中的ServerAgent.bat文件
    - 2. 启动JMeter，添加ServerAgent监听器，配置服务器IP,端口和监控指标
    - 3. 查看监控结果，分析服务器性能问题

## 性能测试场景

### 典型性能测试场景介绍

#### 思考
性能测试定义中要求：性能测试要模拟不同的应用场景。

（例如：电商系统）系统典型的应用场景有哪些？

#### 系统典型应用场景与对应性能场景

| 系统典型应用场景 | 对应的性能场景 |
|----------------|--------------|
| ✓ 电商双11      | ✓ 峰值场景    |
| ✓ 整点秒杀      | ✓ 单业务场景  |
| ✓ 长时间运行    | ✓ 稳定性场景  |
| ✓ 服务器异常    | ✓ 异常场景    |
|                | ✓ 混合场景    |

### （1）有几种典型性能测试场景？
- 单业务场景：每个业务/接口单独压测
- 混合业务场景：多个接口同时压测
- 峰值场景：短时间内并发激增
- 稳定性场景：一定压力下长时间运行
- 异常场景：系统出现故障/异常

### （2）如下几个用户场景分别要用什么性能测试场景来模拟？
- 场景1：电商系统日常情况下，有500万在线用户使用系统（有登录、搜索、下订单、退货等）
- 场景2：电商双11活动期间，有2亿在线用户使用系统（有登录、搜索、下订单、退货等）
- 场景3：电商双11活动当天，每到整点有1000万人同时进行秒杀抢购
- 场景4：电商双11活动期间，实际在线用户数达到预期用户数量的10倍


## 单业务场景压测
（1）什么是单业务场景测试？
- 对各业务/接口单独进行压测，判断性能是否满足需求

（2）为什么要进行单业务场景测试？
- 要验证系统能支持的单业务/接口的最大负载量，是否满足系统业务需求，单业务达标后才能进行混合业务场景测试。

（3）如何做单业务场景性能测试？
1. 先基准测试 - 统计单业务接口的TPS指标（每秒处理的请求数）和响应时间，为后续测试做参考
2. 再负载测试 - 逐步增加负载量（用户数），观察系统的最大处理能力（TPS）是否满足产品设计要求
- 收集性能测试数据
  - 聚合报告
    - 作用：收集性能测试结束后，系统的各项性能指标。如：响应时间、吞吐量、错误率等
    - 位置：测试计划->右键->监听器->聚合报告
    - 参数介绍：
      - Label：每个请求的名称
      - 样本：各请求发出的数量
      - 平均值：平均响应时间（单位：毫秒）
      - 中位数：中位数，50%<=时间
      - 90%百分比：90%<=时间
      - 95%百分比：95%<=时间
      - 最小值：最小响应时间
      - 最大值：最大响应时间
      - 异常%：请求的错误率
      - 吞吐量：默认情况下表示每秒完成的请求数，一般认为它为TPS
      - 接收KB/sec：每秒接收到的千字节数
      - 发送KB/sec：每秒发送的千字节数

## 混合业务场景压测

- 如何执行混合业务场景的性能测试？

    1. 设置性能测试场景（模拟大量用户发送请求 + 按照比例发送请求）
    - 添加线程组，设置线程数（逐步增加）
    - 线程组下添加多个吞吐量控制器，并设置业务吞吐量比例
    业务吞吐量比例 = 单业务TPS/系统所有业务TPS之和

    2. 收集性能测试数据
    - 聚合报告（TPS和响应时间）

    3. 分析性能测试结果
    - 记录系统最大的TPS，与需求要求的TPS进行对比，达标则通过
    记录总TPS，或者 每个业务单独的TPS都可以

### 吞吐量控制器
执行关键点：
1. 设置性能测试场景（即：模拟多用户+按照比例发送请求）
- 添加线程组，设置线程数（逐步增加）
- 线程组下添加多个吞吐量控制器，并设置业务吞吐量比例
业务吞吐量比例 = 单业务TPS/系统所有业务TPS之和
2. 收集性能测试数据（即：记录TPS和响应时间）
- 通过聚合报告收集
3. 分析性能测试结果
- 找出系统的最大TPS，与需求对比，达标则通过

## 峰值场景压测

### 什么是峰值场景测试？
- 验证系统在某段时间内**并发突增**或请求量波动较大的情况下，系统能否正常稳定的提供服务

### 如何做峰值场景性能测试？
使用**并发测试方法**

1. 模拟大量用户（并发用户）同时发送请求（绝对并发）

2. 观察系统的性能指标
   - 首先关注错误率，最好为0
   - 其次关注吞吐量/响应时间，响应时间可能会上升，但峰值结束后能慢慢恢复即可

### 同步定时器

**作用**：阻塞线程（累积一定的请求），当在规定的时间内达到一定的线程数量，这些线程会在同一个时间点一起释放，瞬间产生很大的压力。

**位置**：测试计划-->线程组-->HTTP请求-->(右键添加)定时器-->Synchronizing Timer

**参数介绍**：
- **Number of Simulated Users to Group by**：模拟用户的数量，即指定同时释放的线程数数量
  - 若设置为0，等于设置为线程组中的线程数量
- **Timeout in milliseconds**：超时时间，即超时多少毫秒后同时释放指定的线程数
  - 如果设置为0，该定时器将会等待线程数达到了设置的线程数才释放，若没有达到设置的线程数会一直死等
  - 如果大于0，那么如果超过Timeout in milliseconds中设置的最大等待时间后还没达到设置的线程数，Timer将不再等待，释放已到达的线程。默认为0


### 测试方法

1. 设置性能测试场景（模拟大量用户同时发送请求）
   - 添加线程组，设置线程数为 用户总数（相对并发数）
   - 在HTTP请求下添加同步定时器，并发数可设置为同时发送请求的用户数（绝对并发数）

2. 收集性能测试数据并分析结果
   - 首先关注错误率，最好为0
   - 其次关注吞吐量/响应时间，响应时间可能会上升，但峰值结束后能慢慢恢复即可


## 稳定性场景压测

### 什么是用户正常的业务负载？
- 系统日常运行时，用户所进行的主要业务操作
- 系统日常运行时，一定是多种业务共存，因此需要使用**混合业务场景下**的压力
- 系统日常运行时，每种业务操作的并发/负载量
- 系统日常运行时，并不会永远保持高峰期的压力/负载量，因此压力可以比**高峰期混合业务场景的压力低一些**（例如：CPU使用率在70%时对应的并发数）

### 长时间测试？
- 1天-1周不等

### 性能需求分析：
- 模拟用户正常业务负载量：
  - 系统日常使用时，一般为混合业务（登录/进入首页/获取用户信息/退出）
  - 稳定性运行TPS比之前混合场景测试时的最大TPS低一些
- 不间断运行一段时间
  - 运行1天

### 目标：
- 首先关注错误率，最好为0
- 其次关注吞吐量/响应时间，响应时间（不会明显上升）和吞吐量（不会明显下降）长期处于稳定的范围内

### 什么是稳定性场景测试？
在服务器稳定运行（用户正常的业务负载下）的情况下进行**长时间测试**，并最终保证服务器能满足线上业务需求

### 为什么要进行稳定性场景测试？
- 混合业务场景负载测试和峰值场景并发测试，都是验证**短时间内的系统处理能力**，能否支持高负载；
- 稳定性场景测试，主要是发现**长时间运行时**（系统资源的使用和释放），系统能否稳定提供服务。

### 如何做稳定性场景性能测试？
1. 使用稳定性测试方法：模拟混合业务场景的业务负载，设置长时间运行，观察系统的性能指标变化。
2. 观察系统的性能指标
   - 首先关注错误率，最好为0
   - 其次关注吞吐量/响应时间，响应时间（不会明显上升）和吞吐量（不会明显下降）长期处于稳定的范围内

### 稳定性场景执行

#### 执行关键点：
1. 设置性能测试场景（即：混合业务场景+运行长时间）
   - 通过吞吐量控制器+线程组 配置
2. 收集性能测试数据（即：记录错误率、TPS和响应时间）
   - 通过聚合报告 收集（平均值）
   - 通过HTML测试报告 收集（过程数据）
3. 分析性能测试结果
   - 错误率为0
   - 吞吐量/响应时间在稳定范围内

#### 收集性能测试数据 —— HTML测试报告

**作用**：JMeter支持生成HTML测试报告，以便从测试计划中获得图表和统计信息

**命令**：`jmeter -n -t [jmx file] -l [result file] -e -o [html report folder]`

**示例**：`jmeter -n -t hello.jmx -l result.jtl -e -o ./report`

**参数描述**：
- `-n`：非GUI模式执行JMeter
- `-t [jmx file]`：测试计划保存的路径及.jmx文件名，路径可以是相对路径也可以是绝对路径
- `-l [result file]`：保存生成测试结果的文件，jtl文件格式
- `-e`：测试结束后，生成测试报告
- `-o [html report folder]`：存放生成测试报告的路径，路径可以是相对路径也可以是绝对路径

**注意**：result.jtl和report会自动生成，如果在执行命令时result.jtl和report已存在，必须用先删除，否则在运行命令时就会报错


## Locust 压测

Locust是一款开源的性能测试工具，使用Python代码定义用户行为，不需要笨重的UI或XML配置。

### 主要特点
- 基于Python的开源压测工具，使用纯Python编写测试场景
- 支持分布式压测，可以在多台机器上运行测试
- 支持自定义压测场景，灵活性高
- 支持压测结果可视化，提供实时监控界面
- 支持HTTP、WebSocket等协议

### 安装方法
```bash
pip install locust
```

### 基本测试脚本示例
创建一个简单的locustfile.py文件：
```python
from locust import HttpUser, task, between

class QuickstartUser(HttpUser):
    wait_time = between(1, 2)  # 用户等待时间1-2秒
    
    @task
    def hello_world(self):
        self.client.get("/")
        self.client.get("/hello")
    
    @task(3)  # 权重为3，表示执行频率更高
    def view_items(self):
        for item_id in range(10):
            self.client.get(f"/item?id={item_id}")
            self.wait()
```

### 执行方式
1. **启动Web界面**
   ```bash
   locust -f locustfile.py
   ```
   然后访问 http://localhost:8089 开始测试

2. **命令行模式执行**
   ```bash
   locust -f locustfile.py --headless -u 100 -r 10 -t 1m
   ```
   - `-u`：并发用户数
   - `-r`：每秒新增用户数
   - `-t`：测试持续时间

### 分布式执行
```bash
# 主节点
locust -f locustfile.py --master

# 工作节点
locust -f locustfile.py --worker --master-host=192.168.1.100
```

### 监控指标
Locust提供的主要指标包括：
- 每秒请求数(RPS)
- 响应时间(中位数、95%、99%分位数)
- 失败率
- 用户数

### 优势
- 测试脚本编写简单灵活，使用Python语言
- 支持复杂的测试场景和逻辑
- 分布式压测能力强
- 实时监控界面直观易用
- 开源免费